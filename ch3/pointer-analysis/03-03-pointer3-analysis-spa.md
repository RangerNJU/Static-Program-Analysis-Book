# æŒ‡é’ˆåˆ†æç†è®ºï¼ˆä¸‹ï¼‰

é¦–å…ˆå›é¡¾ä¸€ä¸‹åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åˆ—å‡ºçš„å¤§çº²ã€‚

1. Pointer Analysis: Rules
2. How to Implement Pointer Analysis
3. Pointer Analysis: Algorithms
4. Pointer Analysis with Method Calls

æ‰¿æ¥ä¸Šä¸€ç¯‡ï¼Œæœ¬æ–‡è°ˆè°ˆåŒ…å«æŒ‡é’ˆåˆ†æå¦‚ä½•å¤„ç†å‡½æ•°è°ƒç”¨ã€‚æ¥ä¸‹æ¥ç”¨æŒ‡é’ˆåˆ†æçš„æ–¹å¼æ¥æ„å»ºCall graphï¼Œå…ˆæ¥å¯¹æ¯”ä¸€ä¸‹CHAå’ŒæŒ‡é’ˆåˆ†æä¸¤ç§æ–¹æ³•ï¼š

* CHA: imprecise, introduce spurious call graph edges and points-to relations
* Pointer analysis: more precise than CHA, both for call graph and points-to relations\(a.k.a on-the-fly call graph construction\)

## Pointer Analysis with Method Calls

æœ¬è¯¾å°†ç»™å‡ºä¸€ä¸ªåŒ…å«å‡½æ•°é—´åˆ†æçš„é€‚ç”¨äºå…¨ç¨‹åºçš„ç®—æ³•ã€‚

è€ƒè™‘ä¸‹é¢è¿™æ ·ä¸€å°æ®µä»£ç ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦æœ‰è¿‡ç¨‹é—´çš„åˆ†æï¼Œæ‰èƒ½æœ‰æ›´å‡†ç¡®çš„åˆ†æç»“æœã€‚

```java
void foo(A a) {
    â€¦
    // ğ‘ğ‘¡(ğ‘) = ?
    b = a.bar();
    // ğ‘ğ‘¡(ğ‘) = ?    
    â€¦
}
```

### Rule for Call

å’Œè¿‡ç¨‹é—´åˆ†æç´§å¯†ç›¸å…³çš„æ˜¯è¿‡ç¨‹è°ƒç”¨çš„å¤„ç†ã€‚ä¹Ÿå°±æ˜¯ä¸ŠèŠ‚è¯¾æåˆ°çš„æœ€åä¸€æ¡ä¸Callæœ‰å…³çš„è§„åˆ™ã€‚

è¿™ä¸ªè§„åˆ™çœ‹èµ·æ¥å¤æ‚å¾—å¤šï¼Œæˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥è§£æã€‚é¦–å…ˆï¼Œè¯·è¯»è€…ä»¬æš‚åœä¸€ä¸‹ï¼Œå›å¿†ä¸€èˆ¬è¯­è¨€å¦‚ä½•å¤„ç†è¿‡ç¨‹è°ƒç”¨ã€‚å³è¿‡ç¨‹è°ƒç”¨æ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

å„ä¸ªç¬¦å·çš„å®šä¹‰ä¸ºï¼š

![](../../.gitbook/assets/image-20201201151956869.png)

![](../../.gitbook/assets/image-20201126230831572.png)

> ä¸€ä¸ªå‚è€ƒç­”æ¡ˆï¼šä¿å­˜ç°åœºï¼Œæ„é€ è°ƒç”¨æ ˆå¸§ï¼Œä¼ é€’å‚æ•°ï¼Œè·³è½¬åˆ°ç›®æ ‡å‡½æ•°å¼€å§‹æ‰§è¡Œâ€¦â€¦ç›®æ ‡å‡½æ•°æ‰§è¡Œå®Œæ¯•è·³è½¬å›æ¥ï¼Œåä»é¢„å®šçš„ä½ç½®å–è¿”å›å€¼ï¼ˆè‹¥éœ€è¦ï¼‰ï¼Œæ¢å¤ç°åœºï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œâ€¦â€¦

åœ¨é™æ€åˆ†æä¸­ï¼Œæˆ‘ä»¬æ›´å¤šåœ°å…³å¿ƒæ•°æ®æµï¼Œè€Œéæ§åˆ¶æµã€‚è€Œé’ˆå¯¹Javaï¼Œå¤„ç†å‡½æ•°è°ƒç”¨çš„æ•°æ®æµå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼š

1. ç¡®å®šç›®æ ‡æ–¹æ³•ã€‚ç”¨ç¬¬7è¯¾ä»‹ç»è¿‡çš„Dispatchå‡½æ•°å®Œæˆã€‚
2. ä¼ receiver object

![](../../.gitbook/assets/image-20201126184745576.png)

3. ä¼ å‚æ•°

![](../../.gitbook/assets/image-20201126185008506.png)

4. ä¼ è¿”å›å€¼

![](../../.gitbook/assets/image-20201126185233403.png)

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åº”è§„åˆ™ï¼Œåœ¨PFGä¸Šæ·»åŠ Edgeå®ç°è¿‡ç¨‹é—´ä¿¡æ¯çš„ä¼ é€’ã€‚å®Œæ•´çš„è§„åˆ™å¦‚ä¸‹ï¼š

![](../../.gitbook/assets/image-20201126231116221.png)

#### Detail-1

**Question: Why not add PFG edge ğ‘¥ â†’** $$ ğ‘š_{ğ‘¡â„ğ‘–ğ‘ }$$**ï¼Ÿ**

é€šè¿‡è¿™ä¸¤ä¸ªå›¾å¯ä»¥ç›´è§‚åœ°è¯´æ˜åŸå› ï¼š

![](../../.gitbook/assets/image-20201126231403264.png)

![](../../.gitbook/assets/image-20201126231437769.png)

_åœ¨æ¯æ¬¡ç®—æ³•æ‰§è¡Œæ—¶ï¼Œ_$$ o_i$$_æ˜¯ç¡®å®šçš„æŸä¸ªï¼ˆåªæœ‰ä¸€ä¸ªï¼‰å¯¹è±¡ï¼Œç„¶åé’ˆå¯¹è¿™ä¸ªå¯¹è±¡åšDispatchï¼Œèƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„å”¯ä¸€çš„receiver object._

#### Detail-2

åƒä¹‹å‰ç”¨CHAåšè¿‡ç¨‹é—´åˆ†ææ—¶ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å°†åˆ†æçš„è¿‡ç¨‹å’ŒCall graphæ„å»ºçš„è¿‡ç¨‹ç»“åˆèµ·æ¥ã€‚

![](../../.gitbook/assets/image-20201126231722298.png)

ä¸åŒçš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘ä»¬åªåˆ†æä»mainæ–¹æ³•ï¼ˆæˆ–è€…ä¸€èˆ¬æ€§åœ°è¯´ï¼Œç¨‹åºå…¥å£ï¼‰å¼€å§‹å¯è¾¾çš„éƒ¨åˆ†ã€‚åŸå› æœ‰äºŒï¼š

1. æå‡åˆ†æé€Ÿåº¦ã€‚å› ä¸ºæˆ‘ä»¬èƒ½å¤Ÿé¿å…åˆ†æä¸ä¼šè¢«æ‰§è¡Œåˆ°çš„æ­»ä»£ç ã€‚
2. æå‡åˆ†æç²¾åº¦ã€‚é¿å…äº†unreachableéƒ¨åˆ†çš„ä»£ç è°ƒç”¨reachableéƒ¨åˆ†æ–¹æ³•æ—¶å¯èƒ½å¼•èµ·çš„ç²¾åº¦ä¸‹é™ã€‚

![](../../.gitbook/assets/image-20201126191225969.png)

## Algorithm: PA with Method Calls

æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸ªå…·ä½“çš„ã€æ˜“äºç†è§£å’Œå®ç°çš„ç®—æ³•ã€‚ç”±äºæŒ‡é’ˆåˆ†ææ˜¯é™æ€ç¨‹åºåˆ†æçš„åŸºç¡€ï¼Œç†è§£äº†è¿™ä¸ªçœ‹èµ·æ¥æ¯ç‡¥çš„ç®—æ³•åï¼Œæ›´å®¹æ˜“åœ¨é™æ€ç¨‹åºåˆ†æé¢†åŸŸè§¦ç±»æ—é€šã€‚~~è€Œä¸”æ®è¯´åé¢ä¸¤èŠ‚è¯¾ä¼šå­¦å¾—æ›´åŠ è½»æ¾~~

![](../../.gitbook/assets/image-20201126191650221.png)

ç®—æ³•æ•´ä½“ä¸Šæ¥è¯´å’Œä¸Šä¸€èŠ‚è¯¾æ‰€ä»‹ç»çš„å¤§æ¡†æ¶ç›¸ä¼¼ï¼Œé»„è‰²æ ‡è®°çš„éƒ¨åˆ†æ˜¯è¿™æ¬¡æ–°åŠ å…¥çš„éƒ¨åˆ†ã€‚ç»¿è‰²éƒ¨åˆ†æ˜¯å¯¹æ–°çš„å…¨å±€å˜é‡çš„è¯´æ˜ï¼š

* Sé‡Œçš„statementså°±æ˜¯RMé‡Œmethodsçš„statementsï¼ˆè¯­å¥ï¼‰
* Call Graphå’ŒæŒ‡é’ˆé›†ä½œä¸ºæœ€åçš„è¾“å‡ºã€‚

### Function: AddReachable

AddReachableçš„ä½œç”¨æ˜¯ï¼š

* **è¾“å…¥å‚æ•°**mæ˜¯æœ€æ–°çš„å¯è¾¾æ–¹æ³•ã€‚
* å‡½æ•°ä¿®æ”¹ç»´æŠ¤å…¨å±€çš„RMã€Så’Œ$$ S_m$$ï¼Œå¹¶å¤„ç†æ–°çš„æ–¹æ³•mä¸­çš„Newå’ŒAssignè¯­å¥ã€‚

![](../../.gitbook/assets/image-20201126194125039.png)

#### Detail-3

**Question: ä¸ºä»€ä¹ˆè¦æ£€æŸ¥l-&gt;mæ˜¯å¦åœ¨CGä¸­ï¼Œå³ä¸ºä»€ä¹ˆåŒæ ·çš„l-&gt;må¯èƒ½ä¸æ­¢ä¸€æ¬¡åœ°è¢«å¤„ç†ï¼Ÿ**

_lä»£è¡¨call siteã€‚å¯ä»¥ç”¨è¡Œå·ä½œä¸ºcall siteçš„labelã€‚_

> Answer: $$ o_j, o_k$$åŒæ ·å¯èƒ½é€šè¿‡Dispatchè¿”å›åŒä¸€ä¸ªmã€‚

### Function:ProcessCall

ProcessCallçš„ä½œç”¨æ˜¯ï¼š

* è¾“å…¥çš„$$ o_i$$æ˜¯xæ–°æŒ‡å‘çš„ç›®æ ‡ã€‚
* å‡½æ•°åœ¨å¯è¾¾çš„è¯­å¥é›†åˆSä¸­ï¼Œé€‰æ‹©æ‰€æœ‰ä¸xæœ‰å…³çš„è¿‡ç¨‹è°ƒç”¨ï¼Œåšä¹‹å‰æåˆ°çš„æ•°æ®æµç›¸å…³å››æ­¥å¤„ç†ï¼ˆç¡®å®šè¢«è°ƒç”¨æ–¹æ³•ã€ä¼ å¯¹è±¡ã€ä¼ å‚æ•°ï¼Œä¼ è¿”å›å€¼ï¼‰ã€‚

![](../../.gitbook/assets/image-20201126195311513.png)

![](../../.gitbook/assets/image-20201126195425756.png)

## Example

**åˆ©ç”¨ä¹‹å‰å­¦ä¹ çš„ç®—æ³•åˆ†æä»¥ä¸‹ä»£ç ï¼Œæ„å»ºCall graphå’ŒPFGã€‚**

```java
class A {
    static void main() {
        A a = new A();
        A b = new B();
        A c = b.foo(a);
    }
    A foo(A x) { â€¦ }  
}
class B extends A {
    A foo(A y) {
        A r = new A();
        return r;
    }
}
```

ç­”æ¡ˆå¦‚ä¸‹ï¼š

![](../../.gitbook/assets/image-20201126201000426.png)

è¿™ä¸ªæµä¸æ•æ„Ÿçš„åˆ†æç®—æ³•åœ¨åˆ†æç²¾åº¦ä¸Šä»ç„¶å¯ä»¥æ”¹è¿›ã€‚æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„è¯¾ç¨‹ä¸­å­¦ä¹ ç²¾åº¦æ›´é«˜çš„æµæ•æ„Ÿåˆ†æã€‚

## Key points

* Pointer analysis **rule for method call**
* **Algorithm** for inter-procedural pointer analysis 
* **On-the-fly call graph construction**

